import*as e from"../../core/i18n/i18n.js";import*as t from"../../ui/legacy/legacy.js";import*as i from"../../core/sdk/sdk.js";import*as s from"../../third_party/react-devtools/react-devtools.js";import*as o from"../../core/common/common.js";import*as n from"../../models/workspace/workspace.js";import*as r from"../../models/react_native/react_native.js";import*as a from"../../models/bindings/bindings.js";import*as d from"../../models/logs/logs.js";class l extends i.SDKModel.SDKModel{static FUSEBOX_BINDING_NAMESPACE="react-devtools";rdtModel;constructor(e){super(e);const t=e.model(r.ReactDevToolsBindingsModel.ReactDevToolsBindingsModel);if(!t)throw new Error("Failed to construct ReactDevToolsModel: ReactDevToolsBindingsModel was null");this.rdtModel=t,t.addEventListener("Initialized",this.initialize,this)}initialize(){const e=this.rdtModel;if(!e)throw new Error("Failed to initialize ReactDevToolsModel: ReactDevToolsBindingsModel was null");e.subscribeToDomainMessages(l.FUSEBOX_BINDING_NAMESPACE,(e=>this.onMessage(e))),e.initializeDomain(l.FUSEBOX_BINDING_NAMESPACE).then((()=>this.onInitialization()))}onInitialization(){this.dispatchEventToListeners("Initialized")}async sendMessage(e){const t=this.rdtModel;if(!t)throw new Error("Failed to send message from ReactDevToolsModel: ReactDevToolsBindingsModel was null");await t.sendMessage(l.FUSEBOX_BINDING_NAMESPACE,e)}onMessage(e){this.dispatchEventToListeners("MessageReceived",e)}}i.SDKModel.SDKModel.register(l,{capabilities:4,autostart:!1});var c=Object.freeze({__proto__:null,ReactDevToolsModel:l});const g={title:"React DevTools"},h=e.i18n.registerUIStrings("panels/react_devtools/ReactDevToolsView.ts",g),m=e.i18n.getLocalizedString.bind(void 0,h),M="main";function u(e,t){const{sourceURL:i,line:s,column:r}=t||e;!async function(e,t,i){const s=n.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(e);if(s){const e=await a.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().normalizeUILocation(s.uiLocation(t,i));return void o.Revealer.reveal(e)}const r=a.ResourceUtils.resourceForURL(e);if(r)return void o.Revealer.reveal(r);const l=d.NetworkLog.NetworkLog.instance().requestForURL(e);if(!l)throw new Error("Could not find resource for "+e);o.Revealer.reveal(l)}(i,s-1,r-1)}class v extends t.View.SimpleView{wall;bridge;store;listeners=new Set;constructor(){super(m(g.title)),this.wall={listen:e=>(this.listeners.add(e),()=>{this.listeners.delete(e)}),send:(e,t)=>this.sendMessage(e,t)},this.bridge=s.createBridge(this.wall),this.store=s.createStore(this.bridge),window.addEventListener("beforeunload",(()=>this.bridge.shutdown())),i.TargetManager.TargetManager.instance().addModelListener(l,"MessageReceived",this.onMessage,this),i.TargetManager.TargetManager.instance().addModelListener(l,"Initialized",this.initialize,this),i.TargetManager.TargetManager.instance().addModelListener(i.RuntimeModel.RuntimeModel,i.RuntimeModel.Events.ExecutionContextDestroyed,this.onExecutionContextDestroyed,this),i.TargetManager.TargetManager.instance().addModelListener(i.RuntimeModel.RuntimeModel,i.RuntimeModel.Events.ExecutionContextCreated,this.onExecutionContextCreated,this),this.renderLoader()}renderLoader(){const e=document.createElement("div");e.setAttribute("style","display: flex; flex: 1; justify-content: center; align-items: center");const t=document.createElement("span");t.classList.add("spinner"),e.appendChild(t),this.contentElement.appendChild(e)}clearLoader(){this.contentElement.removeChildren()}initialize(){this.clearLoader();const e=window.matchMedia("(prefers-color-scheme: dark)").matches;s.initialize(this.contentElement,{bridge:this.bridge,store:this.store,theme:e?"dark":"light",canViewElementSourceFunction:()=>!0,viewElementSourceFunction:u})}wasShown(){super.wasShown(),this.registerCSSFiles([s.CSS])}onMessage(e){if(e.data)for(const t of this.listeners)t(e.data)}sendMessage(e,t){for(const s of i.TargetManager.TargetManager.instance().models(l,{scoped:!0}))s.sendMessage({event:e,payload:t})}onExecutionContextDestroyed(e){e.data.name===M&&(this.contentElement.removeChildren(),this.bridge.shutdown(),this.listeners.clear(),this.renderLoader())}onExecutionContextCreated(e){e.data.name===M&&(this.bridge=s.createBridge(this.wall),this.store=s.createStore(this.bridge),this.initialize())}}var p=Object.freeze({__proto__:null,ReactDevToolsViewImpl:v});export{c as ReactDevToolsModel,p as ReactDevToolsView};
